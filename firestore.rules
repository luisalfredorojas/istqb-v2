rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // USERS COLLECTION
    // ========================================
    match /users/{userId} {
      
      // LECTURA: Solo el usuario puede leer su propia información
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // CREACIÓN: Solo al registrarse por primera vez
      allow create: if request.auth != null 
        && request.auth.uid == userId
        // Asegurar que no se cree con subscription premium
        && (!request.resource.data.keys().hasAny(['subscription']) 
            || request.resource.data.subscription.type != 'premium');
      
      // ACTUALIZACIÓN: Permitir actualizar EXCEPTO el campo 'subscription'
      allow update: if request.auth != null 
        && request.auth.uid == userId
        // CRÍTICO: NO permitir modificar subscription desde el cliente
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['subscription']);
      
      // ELIMINACIÓN: No permitir (preservar datos)
      allow delete: if false;
      
      // ========================================
      // HISTORY SUBCOLLECTION (historial de exámenes)
      // ========================================
      match /history/{historyId} {
        // Lectura y escritura solo para el usuario dueño
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // ========================================
    // BLOQUEAR TODO LO DEMÁS
    // ========================================
    // Cualquier otra colección no especificada arriba será bloqueada
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
